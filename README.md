Template parser.

TODO: rewrite this some day